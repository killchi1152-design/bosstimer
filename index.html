<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>âœ¦ å€’è¨ˆæ™‚ï¼ˆæ”¶è—ï¼‹æ’åºï¼‹æé†’ï¼‰(No-Inline-Handlers) âœ¦</title>
<style>
  :root{ --line:#ebdff5; --card:#fff; --ink:#2d2940; --ring:#ffd7f0; }
  *{box-sizing:border-box} body{margin:0;font-family:"Microsoft JhengHei","PingFang TC",system-ui,sans-serif;background:#faf7ff;color:var(--ink)}
  header{position:sticky;top:0;background:#ffffffcc;backdrop-filter:blur(8px);border-bottom:1px dashed var(--line);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{margin:.2rem 0} .sub{opacity:.9}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none;border-radius:12px;padding:8px 12px;font-weight:800;background:#fff;box-shadow:0 0 0 2px var(--ring)}
  .layout{display:flex;gap:16px;align-items:flex-start}
  #main{flex:1;min-width:0}
  #favPanel{width:320px;position:sticky;top:92px;align-self:flex-start;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:10px}
  .fav-item{border:1px dashed #ffd8ef;border-radius:10px;padding:8px;background:#fff;margin-bottom:8px}
  .chap{margin:16px 0}
  .chap-head{display:flex;align-items:center;gap:10px;margin-bottom:6px}
  .chap h2{margin:0;background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 12px}
  .mini{cursor:pointer;border:1px solid var(--line);border-radius:10px;padding:4px 8px;background:#fff}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(300px,1fr))}
  .card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:12px}
  .streams{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .stream{border:1px dashed var(--line);border-radius:12px;padding:10px;background:#fff}
  .stream-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{font-weight:900;background:#ffeaf7;border:1px solid #ffd7f0;border-radius:999px;padding:4px 10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row label{font-weight:800; opacity:.9}
  input.time{width:70px;padding:6px 8px;border:1px solid var(--line);border-radius:8px}
  .star-btn{width:32px;height:32px;border-radius:50%;border:1px solid #cfc6da;background:#fff;cursor:pointer;font-size:16px}
  .star-btn.active{background:#fff7cc;border-color:#ffd24d}
  .count{font-weight:900;margin-top:4px}
  #error{color:#b0054e;font-weight:800;display:none;margin-left:8px}
  .author-link{margin-top:10px;padding:10px;background:#fff3fb;border:1px dashed #f0b9d6;border-radius:12px;text-align:center}
  .author-link a{color:#d12c6a;font-weight:800;text-decoration:none}
  .author-link a:hover{text-decoration:underline}
  .diag{font-size:12px; opacity:.7; margin-left:8px}
  .hide{display:none}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>âœ¦ å€’è¨ˆæ™‚ï¼ˆæ”¶è—ï¼‹æ’åºï¼‹æé†’ï¼‰</h1>
    <div class="sub">ç« ç¯€/åˆ†æµå¯æ’åºï¼›åˆ†æµå¯æ”¶è—ï¼ˆå³å´é¡¯ç¤ºï¼‰ï¼›æœ‰æé†’éŸ³æ•ˆã€‚<span class="diag" id="diag"></span></div>
    <div class="toolbar">
      <button class="btn" id="btnReset">é‡ç½®è³‡æ–™</button>
      <button class="btn" id="btnRepair">å¼·åˆ¶ä¿®å¾©</button>
      <label>éŸ³é‡ <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7"></label>
      <label><input id="mute" type="checkbox"> éœéŸ³</label>
      <span id="error"></span>
    </div>
    <div class="author-link">
      ğŸ“º ä½œè€…ç›´æ’­å¹³å° ğŸ‘‰ 
      <a href="https://www.youtube.com/channel/UCGaBu2e9vi-tXuZmGWRUBQQ" target="_blank" rel="noopener noreferrer">
        YouTube é »é“
      </a><br/>
      æ”¯æŒä½œè€…ç¹¼çºŒæ›´æ–°ï¼Œæ­¡è¿è¨‚é–±ç›´æ’­ï¼ğŸ’–
    </div>
  </div>
</header>

<div class="wrap layout">
  <div id="main"></div>
  <aside id="favPanel">
    <h3>â­ æ”¶è—çš„åˆ†æµ</h3>
    <div id="favList"></div>
  </aside>
</div>

<script>
// ===== No inline handlers; event delegation =====
(function(){
  var MAPS = {
    "ç¬¬ä¸ƒç« ": ["æ‰å¡é‡Œè€¶çˆ¾äº¤å‰è·¯","ç‹é™µä¸€å±¤","ç‹é™µäºŒå±¤","ç‹é™µä¸‰å±¤"],
    "ç¬¬å…«ç« ": ["æ°´è·¯æ©‹åœ°å€","é˜¿é›·é­¯è«¾ç”·çˆµé ˜","é­”æ—æ”¶ç›£æ‰€ç¬¬ä¸€å€","é­”æ—æ”¶ç›£æ‰€ç¬¬ä¸‰å€","é­”æ—æ”¶ç›£æ‰€ç¬¬å››å€","é­”æ—æ”¶ç›£æ‰€ç¬¬äº”å€"],
    "ç¬¬ä¹ç« ": ["å¥³ç¥çš„å¤é™¢","ä½©è¿ªç±³å®‰å¤–åŸ","é­”æ³•å¸«ä¹‹å¡”ä¸€å±¤","é­”æ³•å¸«ä¹‹å¡”äºŒå±¤","é­”æ³•å¸«ä¹‹å¡”ä¸‰å±¤"],
    "ç¬¬åç« ": ["å¤§æ•™å ‚æ‡ºæ‚”è·¯","å¤§æ•™å ‚æ­£æ®¿","å¤§æ•™å ‚å¤§è¿´å»Š","å¤§æ•™å ‚è‡³è–æ‰€"]
  };
  var KEY="all_map_timers";
  var saved;
  try{ saved=JSON.parse(localStorage.getItem(KEY)||"{}"); }catch(e){ saved={}; }
  if(!saved || typeof saved!=="object") saved={};
  var defOrder = Object.keys(MAPS);
  if(!Array.isArray(saved._chapOrder) || !saved._chapOrder.length || saved._chapOrder.some(function(c){return !MAPS[c];})){
    saved._chapOrder = defOrder.slice();
    persist();
  }
  var main = document.getElementById('main'), favList = document.getElementById('favList'), diag=document.getElementById('diag');
  var timers={};
  function persist(){ try{ localStorage.setItem(KEY, JSON.stringify(saved)); }catch(e){} }
  function idEncode(s){ try{ return 'i_'+btoa(unescape(encodeURIComponent(s))).replace(/=+$/,''); }catch(e){ return 'i_'+s.replace(/[^a-z0-9]/gi,'_'); }}
  function ensureStreams(id){ if(!Array.isArray(saved[id])) saved[id]=[]; }
  function renderAll(){
    main.innerHTML="";
    saved._chapOrder.forEach(function(chap){
      var sec=document.createElement('section'); sec.className='chap';
      sec.innerHTML='<div class="chap-head"><h2>'+chap+'</h2></div><div class="grid"></div>';
      var grid=sec.querySelector('.grid');
      (MAPS[chap]||[]).forEach(function(map){
        var id=chap+'-'+map, did=idEncode(id); ensureStreams(id);
        var card=document.createElement('div'); card.className='card';
        card.innerHTML='\
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">\
            <h3 style="margin:0">'+map+'</h3>\
            <button class="btn add-stream" data-id="'+id+'">æ–°å¢åˆ†æµ</button>\
          </div>\
          <div class="streams" id="'+did+'-streams"></div>';
        grid.appendChild(card);
        renderStreams(id);
      });
      main.appendChild(sec);
    });
    renderFavs();
    diag.textContent='ï¼ˆç« ç¯€æ•¸ï¼š'+saved._chapOrder.length+'ï¼‰';
  }
  function renderStreams(id){
    var did=idEncode(id), box=document.getElementById(did+'-streams'); if(!box) return;
    box.innerHTML="";
    (saved[id]||[]).forEach(function(s,idx){
      var sid=did+'-'+idx;
      var el=document.createElement('div'); el.className='stream';
      el.innerHTML='\
      <div class="stream-head">\
        <div class="badge">åˆ†æµ'+(idx+1)+'</div>\
        <div class="row">\
          <button class="mini mv-stream" data-id="'+id+'" data-idx="'+idx+'" data-dir="-1">â†‘</button>\
          <button class="mini mv-stream" data-id="'+id+'" data-idx="'+idx+'" data-dir="1">â†“</button>\
          <button class="star-btn '+(s.fav?'active':'')+' fav-btn" data-id="'+id+'" data-idx="'+idx+'">'+(s.fav?'â­':'â˜†')+'</button>\
        </div>\
      </div>\
      <div class="row">\
        <label>æå‰æé†’(åˆ†)</label>\
        <input id="'+sid+'-a" class="time" type="number" value="'+(typeof s.a==='number'?s.a:5)+'">\
      </div>\
      <div class="row">\
        <input id="'+sid+'-h" class="time" type="number" placeholder="æ™‚" value="'+(s.h||0)+'">\
        <input id="'+sid+'-m" class="time" type="number" placeholder="åˆ†" value="'+(s.m||0)+'">\
        <input id="'+sid+'-s" class="time" type="number" placeholder="ç§’" value="'+(s.s||0)+'">\
      </div>\
      <div class="row">\
        <button class="btn start" data-id="'+id+'" data-idx="'+idx+'">é–‹å§‹</button>\
        <button class="btn pause" data-id="'+id+'" data-idx="'+idx+'">æš«åœ</button>\
        <button class="btn reset" data-id="'+id+'" data-idx="'+idx+'">é‡è¨­</button>\
        <button class="btn del" data-id="'+id+'" data-idx="'+idx+'">åˆªé™¤</button>\
      </div>\
      <div class="count" id="'+sid+'-count">'+(s.end && s.end>Date.now() ? 'è¨ˆæ™‚ä¸­' : 'å°šæœªè¨­å®š')+'</div>';
      box.appendChild(el);
      if(s.end && s.end>Date.now()) resumeTimer(id, idx, s.end, s.a||0);
    });
  }
  function renderFavs(){
    favList.innerHTML="";
    var items=[];
    saved._chapOrder.forEach(function(chap){
      (MAPS[chap]||[]).forEach(function(map){
        var id=chap+'-'+map;
        (saved[id]||[]).forEach(function(s,idx){ if(s&&s.fav) items.push({chap:chap,map:map,id:id,idx:idx,s:s}); });
      });
    });
    if(!items.length){ favList.innerHTML='<div style="opacity:.7">å°šæœªæ”¶è—ï¼ˆé»åˆ†æµå³ä¸Šè§’ â˜† æ”¶è—ï¼‰</div>'; return; }
    items.forEach(function(obj){
      var did=idEncode(obj.id), sid=did+'-'+obj.idx;
      var card=document.createElement('div'); card.className='fav-item';
      card.innerHTML='\
        <div style="opacity:.85">'+obj.chap+' ï¼ '+obj.map+' ï¼ åˆ†æµ'+(obj.idx+1)+'</div>\
        <div class="count" id="fav-'+sid+'-count">'+(obj.s.end && obj.s.end>Date.now() ? 'è¨ˆæ™‚ä¸­' : 'å°šæœªè¨­å®š')+'</div>\
        <div class="row" style="margin-top:6px">\
          <button class="btn goto" data-id="'+obj.id+'" data-idx="'+obj.idx+'">å‰å¾€</button>\
          <button class="btn start" data-id="'+obj.id+'" data-idx="'+obj.idx+'">é–‹å§‹</button>\
          <button class="btn pause" data-id="'+obj.id+'" data-idx="'+obj.idx+'">æš«åœ</button>\
        </div>';
      favList.appendChild(card);
    });
  }
  // Actions
  function addStream(id){ saved[id].push({a:5,fav:false}); persist(); renderStreams(id); }
  function delStream(id,idx){ saved[id].splice(idx,1); persist(); renderStreams(id); renderFavs(); }
  function moveStream(id,idx,dir){ var a=saved[id], j=idx+dir; if(!a||j<0||j>=a.length) return; var t=a[idx]; a[idx]=a[j]; a[j]=t; persist(); renderStreams(id); renderFavs(); }
  function toggleFav(id,idx){ var s=saved[id][idx]||(saved[id][idx]={}); s.fav=!s.fav; persist(); renderStreams(id); renderFavs(); }
  function scrollToStream(id,idx){ var did=idEncode(id), box=document.getElementById(did+'-streams'); if(!box) return; var el=box.children[idx]; if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); }
  function startTimer(id,idx){
    var did=idEncode(id), sid=did+'-'+idx;
    var h=+document.getElementById(sid+'-h').value||0, m=+document.getElementById(sid+'-m').value||0, s=+document.getElementById(sid+'-s').value||0, a=+document.getElementById(sid+'-a').value||0;
    var total=h*3600+m*60+s; if(total<=0){ return alert('è«‹è¼¸å…¥æ™‚é–“'); }
    var end=Date.now()+total*1000; var old=saved[id][idx]||{};
    saved[id][idx]={h:h,m:m,s:s,a:a,end:end,fav:!!old.fav}; persist();
    clearInterval(timers[sid]); resumeTimer(id,idx,end,a);
  }
  function pauseTimer(id,idx){
    var did=idEncode(id), sid=did+'-'+idx; clearInterval(timers[sid]);
    var h=+document.getElementById(sid+'-h').value||0, m=+document.getElementById(sid+'-m').value||0, s=+document.getElementById(sid+'-s').value||0, a=+document.getElementById(sid+'-a').value||0;
    var old=saved[id][idx]||{}; saved[id][idx]={h:h,m:m,s:s,a:a,fav:!!old.fav}; persist();
  }
  function resetTimer(id,idx){
    var did=idEncode(id), sid=did+'-'+idx; clearInterval(timers[sid]);
    var old=saved[id][idx]||{}; saved[id][idx]={a:(typeof old.a==='number'?old.a:5), fav:!!old.fav}; persist();
    var mainEl=document.getElementById(sid+'-count'); if(mainEl) mainEl.textContent='å°šæœªè¨­å®š';
    var favEl=document.getElementById('fav-'+sid+'-count'); if(favEl) favEl.textContent='å°šæœªè¨­å®š';
  }
  function resumeTimer(id,idx,end,a){
    var did=idEncode(id), sid=did+'-'+idx; clearInterval(timers[sid]);
    timers[sid]=setInterval(function(){
      var remain=Math.max(0,Math.floor((end-Date.now())/1000));
      var mm=Math.floor(remain/60).toString(); var ss=(remain%60); ss=(ss<10?'0':'')+ss;
      var mainEl=document.getElementById(sid+'-count'); if(mainEl) mainEl.textContent='å‰©é¤˜ '+mm+':'+ss;
      var favEl=document.getElementById('fav-'+sid+'-count'); if(favEl) favEl.textContent='å‰©é¤˜ '+mm+':'+ss;
      if(remain<=0){ clearInterval(timers[sid]); var s=saved[id][idx]||{}; saved[id][idx]={h:s.h,m:s.m,s:s.s,a:s.a,fav:!!s.fav}; persist(); if(mainEl) mainEl.textContent='å°šæœªè¨­å®š'; if(favEl) favEl.textContent='å°šæœªè¨­å®š'; }
    },1000);
  }

  // Toolbar events
  document.getElementById('btnReset').addEventListener('click', function(){ try{ localStorage.removeItem(KEY); }catch(e){} location.reload(); });
  document.getElementById('btnRepair').addEventListener('click', function(){ saved._chapOrder = defOrder.slice(); persist(); renderAll(); });

  // Delegated events for main & favs
  document.body.addEventListener('click', function(e){
    var t=e.target;
    if(t.classList.contains('add-stream')){ addStream(t.dataset.id); return; }
    if(t.classList.contains('del')){ delStream(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('mv-stream')){ moveStream(t.dataset.id, +t.dataset.idx, +t.dataset.dir); return; }
    if(t.classList.contains('fav-btn')){ toggleFav(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('goto')){ scrollToStream(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('start')){ startTimer(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('pause')){ pauseTimer(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('reset')){ resetTimer(t.dataset.id, +t.dataset.idx); return; }
  });

  // Render
  renderAll();
})();
</script>
</body>
</html>
