<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>倒計時（⭐收藏＋🔔提醒音＋💾保存＋🌙暗黑模式）—穩定版</title>
<style>
  :root{
    --bg:#faf7ff; --ink:#2d2940; --card:#fff; --line:#ebdff5; --ring:#ffd7f0;
    --accent:#d12c6a; --muted:#6b6780; --chip:#ffeaf7; --chip-border:#ffd7f0;
    --star:#cfc6da; --star-active:#ffd24d; --star-active-bg:#fff7cc;
  }
  body.dark{
    --bg:#11121a; --ink:#eae7f8; --card:#171826; --line:#2a2b3c; --ring:#3a2a46;
    --accent:#ff7aa5; --muted:#bdb9d6; --chip:#2a2031; --chip-border:#3d2b45;
    --star:#4a4b63; --star-active:#ffd24d; --star-active-bg:#4b3b00;
  }

  *{box-sizing:border-box}
  body{margin:0;font-family:"Microsoft JhengHei","PingFang TC",system-ui,sans-serif;background:var(--bg);color:var(--ink)}
  header{position:sticky;top:0;background:color-mix(in oklab, var(--card) 86%, transparent);backdrop-filter:blur(8px);border-bottom:1px dashed var(--line);z-index:10}
  .wrap{max-width:1200px;margin:0 auto;padding:14px 16px}
  h1{margin:.2rem 0} .sub{opacity:.85}
  .toolbar{display:flex;gap:10px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .btn{cursor:pointer;border:none;border-radius:12px;padding:8px 12px;font-weight:800;background:var(--card);box-shadow:0 0 0 2px var(--ring);color:var(--ink)}
  .btn:hover{box-shadow:0 0 0 2px color-mix(in oklab, var(--ring) 70%, var(--accent))}
  .layout{display:flex;gap:16px;align-items:flex-start}
  #main{flex:1;min-width:0}
  #favPanel{width:320px;position:sticky;top:112px;align-self:flex-start;background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .fav-item{border:1px dashed var(--chip-border);border-radius:10px;padding:8px;background:var(--card);margin-bottom:8px}

  .fav-item{cursor:grab}
  

  .chap{margin:16px 0}
  .chap h2{display:inline-block;margin:0 0 10px;border:1px solid var(--line);border-radius:999px;padding:6px 12px;background:var(--card)}
  .grid{display:grid;gap:12px;grid-template-columns:repeat(auto-fit,minmax(280px,1fr))}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:12px}
  .streams{display:flex;flex-direction:column;gap:10px;margin-top:8px}
  .stream{border:1px dashed var(--line);border-radius:12px;padding:10px;background:var(--card)}
  .stream-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .badge{font-weight:900;background:var(--chip);border:1px solid var(--chip-border);border-radius:999px;padding:4px 10px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .row label{font-weight:800;opacity:.9}
  input.time{width:70px;padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--ink)}
  .star-btn{width:32px;height:32px;border-radius:50%;border:1px solid var(--star);background:var(--card);cursor:pointer;font-size:16px;color:var(--ink)}
  .star-btn.active{background:var(--star-active-bg);color:#8a6a00;border-color:var(--star-active)}
  body.dark .star-btn.active{color:var(--star-active)}
  .count{font-weight:900;margin-top:4px}
  .author-link{margin-top:10px;padding:10px;background:var(--chip);border:1px dashed var(--chip-border);border-radius:12px;text-align:center}
  .author-link a{color:var(--accent);font-weight:800;text-decoration:none}
  .author-link a:hover{text-decoration:underline}
  .diag{font-size:12px; opacity:.7; margin-left:8px}
  .title{padding:6px 8px;border:1px solid var(--line);border-radius:8px;background:var(--card);color:var(--ink);min-width:200px}

.fav-item{display:flex;flex-direction:row;align-items:center;justify-content:space-between;padding:6px 10px;margin:4px 0}
.fav-item .count{margin-left:12px;white-space:nowrap;opacity:.8}
.fav-item .row{margin-top:0 !important}

.fav-item {
  display: flex;
  flex-direction: column;
  align-items: stretch;
  padding: 8px 10px;
  margin: 6px 0;
}
.fav-item > div { margin: 2px 0; }
.fav-item .count { text-align: center; }
.fav-item .row { justify-content: center; }

</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>倒計時（⭐收藏＋🔔提醒音＋💾保存＋🌙暗黑模式）—穩定版</h1>
    <div class="sub">章節永遠顯示；分流可新增；⭐收藏；🔔提醒音；💾自動保存；🌙暗黑主題。<span class="diag" id="diag"></span></div>
    <div class="toolbar">
      <button class="btn" id="btnReset">重置資料</button>
      <button class="btn" id="btnEnableAudio">啟用提醒音</button>
      <button class="btn" id="btnToggleDark">🌙 暗黑模式</button>
      <label>音量 <input id="vol" type="range" min="0" max="1" step="0.01" value="0.7"></label>
      <label><input id="mute" type="checkbox"> 靜音</label>
    </div>
    <div class="author-link">
      📺 作者直播平台 👉 
      <a href="https://www.youtube.com/channel/UCGaBu2e9vi-tXuZmGWRUBQQ" target="_blank" rel="noopener noreferrer">
        YouTube 頻道
      </a><br/>
      支持作者繼續更新，歡迎訂閱直播！💖
    </div>
  </div>
</header>

<div class="wrap layout">
  <div id="main"></div>
  <aside id="favPanel">
    <h3>⭐ 收藏的分流</h3>
    <div id="favList"></div>
  </aside>
</div>

<script>
(function(){
  // ===== 固定章節（保證顯示） =====
  var MAPS = {
    "第七章": ["扎卡里耶爾交叉路","王陵一層","王陵二層","王陵三層"],
    "第八章": ["水路橋地區","阿雷魯諾男爵領","魔族收監所第一區","魔族收監所第三區","魔族收監所第四區","魔族收監所第五區"],
    "第九章": ["女神的古院","佩迪米安外城","魔法師之塔一層","魔法師之塔二層","魔法師之塔三層"],
    "第十章": ["大教堂懺悔路","大教堂正殿","大教堂大迴廊","大教堂至聖所"],
    "自訂": ["自訂計時器"]
  };
  var CUSTOM_ID = '自訂-自訂計時器';

  // ===== 儲存鍵 =====
  var KEY="full_stable_state_v1";
  var THEME_KEY="theme_mode_pref";

  // ===== 狀態載入 =====
  var saved;
  try{ saved=JSON.parse(localStorage.getItem(KEY)||"{}"); }catch(e){ saved={}; }
  if(!saved || typeof saved!=="object") saved={};
  if(!Array.isArray(saved._chapOrder) || !saved._chapOrder.length){
    saved._chapOrder = Object.keys(MAPS);
    persist();
  }

  // ===== 主題（亮/暗） =====
  try{
    var t=localStorage.getItem(THEME_KEY)||"auto";
    if(t==="dark" || (t==="auto" && window.matchMedia && matchMedia('(prefers-color-scheme: dark)').matches)){
      document.body.classList.add('dark');
    }
  }catch(e){}
  document.getElementById('btnToggleDark').addEventListener('click', function(){
    document.body.classList.toggle('dark');
    try{ localStorage.setItem(THEME_KEY, document.body.classList.contains('dark')?'dark':'light'); }catch(e){}
  });

  // ===== 音效 =====
  var actx=null, master=null;
  function ensureAudio(){
    if(!actx){
      try{ actx=new (window.AudioContext||window.webkitAudioContext)(); }catch(e){ console.warn(e); }
      if(actx){
        master=actx.createGain(); master.gain.value=parseFloat(document.getElementById('vol').value||"0.7"); master.connect(actx.destination);
      }
    }
    if(actx && actx.state==='suspended'){ actx.resume(); }
  }
  function playChime(){
    if(document.getElementById('mute').checked) return;
    ensureAudio(); if(!actx) return;
    var now=actx.currentTime;
    [660,880,990].forEach(function(f,i){
      var o=actx.createOscillator(), g=actx.createGain();
      o.type='triangle'; o.frequency.value=f; o.connect(g); g.connect(master);
      g.gain.setValueAtTime(.45, now+i*.1);
      g.gain.exponentialRampToValueAtTime(.001, now+i*.1+.45);
      o.start(now+i*.1); o.stop(now+i*.1+.45);
    });
  }
  document.getElementById('btnEnableAudio').addEventListener('click', function(){
    ensureAudio(); alert('提醒音已啟用（若瀏覽器原本阻擋，現在可播放）');
  });
  document.getElementById('vol').addEventListener('input', function(e){
    if(master) master.gain.value=parseFloat(e.target.value||"0.7");
  });

  // ===== 工具 =====
  function persist(){ try{ localStorage.setItem(KEY, JSON.stringify(saved)); }catch(e){} }
  function ensureStreams(id){ if(!Array.isArray(saved[id])) saved[id]=[]; }
  function idEncode(s){ try{ return 'i_'+btoa(unescape(encodeURIComponent(s))).replace(/=+$/,''); }catch(e){ return 'i_'+s.replace(/[^a-z0-9]/gi,'_'); } }

  // ===== 渲染 =====
  var main=document.getElementById('main'), favList=document.getElementById('favList');
  function renderAll(){
    main.innerHTML="";
    saved._chapOrder.forEach(function(chap){
      var sec=document.createElement('section'); sec.className='chap';
      sec.innerHTML='<h2>'+chap+'</h2><div class="grid"></div>';
      var grid=sec.querySelector('.grid');
      (MAPS[chap]||[]).forEach(function(map){
        var id=chap+'-'+map, did=idEncode(id); ensureStreams(id);
        // 預設在自訂區建立一個分流
        if(id===CUSTOM_ID && saved[id].length===0){
          saved[id].push({a:5,fav:false,title:'自訂計時器 1'}); persist();
        }
        var card=document.createElement('div'); card.className='card';
        card.innerHTML='\
          <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">\
            <h3 style="margin:0">'+map+'</h3>\
            <button class="btn add-stream" data-id="'+id+'">新增分流</button>\
          </div>\
          <div class="streams" id="'+did+'-streams"></div>';
        grid.appendChild(card);
        renderStreams(id);
      });
      main.appendChild(sec);
    });
    renderFavs();
    var d=document.getElementById('diag'); if(d) d.textContent='（章節數：'+saved._chapOrder.length+'）';
  }
  function renderStreams(id){
    var did=idEncode(id), box=document.getElementById(did+'-streams'); if(!box) return;
    box.innerHTML="";
    (saved[id]||[]).forEach(function(s,idx){
      var sid=did+'-'+idx;
      var el=document.createElement('div'); el.className='stream';
      var titleField = '';
      if(id===CUSTOM_ID){
        var tval = (s && s.title) ? s.title : ('自訂計時器 '+(idx+1));
        titleField = '<div class="row"><label>標題</label><input id="'+sid+'-title" class="title" type="text" value="'+tval.replace(/"/g,'&quot;')+'"></div>';
      }
      el.innerHTML='\
        <div class="stream-head">\
          <div class="badge">分流'+(idx+1)+'</div>\
          <button class="star-btn '+(s.fav?'active':'')+' fav-btn" title="收藏/取消" data-id="'+id+'" data-idx="'+idx+'">'+(s.fav?'⭐':'☆')+'</button>\
        </div>' +
        titleField +
        '<div class="row"><label>提前提醒(分)</label><input id="'+sid+'-a" class="time" type="number" value="'+(typeof s.a==='number'?s.a:5)+'"></div>\
        <div class="row">\
          <input id="'+sid+'-h" class="time" type="number" placeholder="時" value="'+(s.h||0)+'">\
          <input id="'+sid+'-m" class="time" type="number" placeholder="分" value="'+(s.m||0)+'">\
          <input id="'+sid+'-s" class="time" type="number" placeholder="秒" value="'+(s.s||0)+'">\
        </div>\
        <div class="row">\
          <button class="btn start" data-id="'+id+'" data-idx="'+idx+'">開始</button>\
          <button class="btn pause" data-id="'+id+'" data-idx="'+idx+'">暫停</button>\
          <button class="btn reset" data-id="'+id+'" data-idx="'+idx+'">重設</button>\
          <button class="btn del" data-id="'+id+'" data-idx="'+idx+'">刪除</button>\
        </div>\
        <div class="count" id="'+sid+'-count">'+(s.end && s.end>Date.now() ? '計時中' : '尚未設定')+'</div>';
      box.appendChild(el);
      if(s.end && s.end>Date.now()) resumeTimer(id, idx, s.end, s.a||0, !!s._preFired);
    });
  }
  
// 讓收藏可以用按鈕調整順序
if(!window.moveFav){
  window.moveFav = function(key, dir){
    try{
      if(!Array.isArray(saved._favOrder)) return;
      var i = saved._favOrder.indexOf(key);
      if(i === -1) return;
      if(dir === 'up' && i>0){
        var tmp = saved._favOrder[i-1]; saved._favOrder[i-1] = saved._favOrder[i]; saved._favOrder[i] = tmp;
      }else if(dir === 'down' && i<saved._favOrder.length-1){
        var tmp2 = saved._favOrder[i+1]; saved._favOrder[i+1] = saved._favOrder[i]; saved._favOrder[i] = tmp2;
      }else{
        return;
      }
      persist();
      renderFavs();
      try{ _cloudSaveHook(key.split('#')[0], parseInt(key.split('#')[1],10)); }catch(e){}
    }catch(e){ console.error(e); }
  };
}

// === 收藏排序：置頂 ===
if(!window.moveFavTop){
  window.moveFavTop = function(key){
    try{
      if(!Array.isArray(saved._favOrder)) return;
      var i = saved._favOrder.indexOf(key);
      if(i <= 0) return;
      saved._favOrder.splice(i,1);
      saved._favOrder.unshift(key);
      persist();
      renderFavs();
      try{ _cloudSaveHook(key.split('#')[0], parseInt(key.split('#')[1],10)); }catch(e){}
    }catch(e){ console.error(e); }
  };
}

function renderFavs(){
    favList.innerHTML="";
    var items=[];
    saved._chapOrder.forEach(function(chap){
      (MAPS[chap]||[]).forEach(function(map){
        var id=chap+'-'+map;
        (saved[id]||[]).forEach(function(s,idx){ if(s && s.fav) items.push({chap:chap,map:map,id:id,idx:idx,s:s}); });
      });
    });
    function favKey(obj){ return obj.id+'#'+obj.idx; }

    if(!Array.isArray(saved._favOrder)){ saved._favOrder = []; }
    saved._favOrder = saved._favOrder.filter(function(k){
      return items.some(function(it){ return favKey(it)===k; });
    });
    items.forEach(function(it){
      var k=favKey(it);
      if(saved._favOrder.indexOf(k)===-1) saved._favOrder.push(k);
    });
    persist();

    items.sort(function(a,b){
      return saved._favOrder.indexOf(favKey(a)) - saved._favOrder.indexOf(favKey(b));
    });

    if(!items.length){
      favList.innerHTML='<div style="opacity:.7">尚未收藏（在分流右上角點 ☆）</div>';
      return;
    }

    function pad(n){ return (n<10?'0':'')+n; }
    function fmtHMS(h,m,s){
      var total=h*3600+m*60+s;
      var hh=Math.floor(total/3600), mm=Math.floor((total%3600)/60), ss=total%60;
      if(hh>0) return hh+':'+pad(mm)+':'+pad(ss);
      return mm+':'+pad(ss);
    }

    items.forEach(function(obj, pos){
      var did=idEncode(obj.id), sid=did+'-'+obj.idx;
      var key = obj.id+'#'+obj.idx;
      var card=document.createElement('div'); card.className='fav-item';
      var line = obj.chap+' ／ '+obj.map;
      if(obj.id===CUSTOM_ID && obj.s && obj.s.title){ line += ' ／ '+obj.s.title; }

      var status='尚未設定';
      if(obj.s && obj.s.end && obj.s.end>Date.now()){
        var remain=Math.max(0,Math.floor((obj.s.end-Date.now())/1000));
        var mm=Math.floor(remain/60), ss=remain%60;
        status='剩餘 '+mm+':'+(ss<10?'0':'')+ss;
      }else if(obj.s && (obj.s.h||obj.s.m||obj.s.s)){
        status='已設定 '+fmtHMS(+obj.s.h||0,+obj.s.m||0,+obj.s.s||0);
      }

      card.innerHTML='\
        <div style="margin-bottom:2px;font-weight:500;text-align:left">'+line+' ／ 分流'+(obj.idx+1)+'</div>\
        <div id="fav-'+sid+'-count" style="margin-bottom:4px;text-align:center" class="count">'+status+'</div>\
        <div class="row" style="gap:6px;justify-content:center;flex-wrap:wrap">\
          <button class="btn small pin-top" data-key="'+key+'" '+(pos===0?'disabled':'')+'>置頂</button>\
          <button class="btn small move-up" data-key="'+key+'" '+(pos===0?'disabled':'')+'>上移</button>\
          <button class="btn small move-down" data-key="'+key+'" '+(pos===items.length-1?'disabled':'')+'>下移</button>\
          <button class="btn goto" data-id="'+obj.id+'" data-idx="'+obj.idx+'">前往</button>\
        </div>';
      favList.appendChild(card);
      if(obj.s && obj.s.end && obj.s.end>Date.now()) resumeTimer(obj.id, obj.idx, obj.s.end, obj.s.a||0, !!obj.s._preFired);
    });
  }

  // ===== 計時器（含提醒音效） =====
  var timers={};
  function startTimer(id,idx){
    ensureAudio();
    var did=idEncode(id), sid=did+'-'+idx;
    var h=+document.getElementById(sid+'-h').value||0;
    var m=+document.getElementById(sid+'-m').value||0;
    var s=+document.getElementById(sid+'-s').value||0;
    var a=+document.getElementById(sid+'-a').value||0;
    var old=saved[id][idx]||{};
    var title = old.title;
    if(id===CUSTOM_ID){
      var ti=document.getElementById(sid+'-title');
      title = ti ? ti.value.trim() : (title||('自訂計時器 '+(idx+1)));
    }
    var total=h*3600+m*60+s; if(total<=0){ return alert('請輸入時間'); }
    var end=Date.now()+total*1000;
    saved[id][idx]={h:h,m:m,s:s,a:a,end:end,fav:!!old.fav,_preFired:false,title:title}; persist();
    try{ _cloudSaveHook(id, idx); }catch(e){}

    var remain=Math.max(0,Math.floor((end-Date.now())/1000));
    var mm=Math.floor(remain/60).toString();
    var ss=(remain%60); ss=(ss<10?'0':'')+ss;
    var mainEl=document.getElementById(sid+'-count'); if(mainEl) mainEl.textContent='剩餘 '+mm+':'+ss;
    var favEl=document.getElementById('fav-'+sid+'-count'); if(favEl) favEl.textContent='剩餘 '+mm+':'+ss;
    clearInterval(timers[sid]); resumeTimer(id,idx,end,a,false);
  }
  function pauseTimer(id,idx){
    var did=idEncode(id), sid=did+'-'+idx;
    clearInterval(timers[sid]);
    var h=+document.getElementById(sid+'-h').value||0;
    var m=+document.getElementById(sid+'-m').value||0;
    var s=+document.getElementById(sid+'-s').value||0;
    var a=+document.getElementById(sid+'-a').value||0;
    var old=saved[id][idx]||{};
    var title = old.title;
    if(id===CUSTOM_ID){
      var ti=document.getElementById(sid+'-title');
      title = ti ? ti.value.trim() : title;
    }
    saved[id][idx]={h:h,m:m,s:s,a:a,fav:!!old.fav,_preFired:!!old._preFired,title:title};
    persist();
    try{ _cloudSaveHook(id, idx); }catch(e){}

    var el=document.getElementById(sid+'-count'); if(el) el.textContent='尚未設定';
    var fel=document.getElementById('fav-'+sid+'-count'); if(fel) fel.textContent='尚未設定';
  }
  function resetTimer(id,idx){
    var did=idEncode(id), sid=did+'-'+idx;
    clearInterval(timers[sid]);
    var old=saved[id][idx]||{};
    var base = {a:(typeof old.a==='number'?old.a:5), fav:!!old.fav};
    if(id===CUSTOM_ID){ base.title = old.title || ('自訂計時器 '+(idx+1)); }
    saved[id][idx]=base;
    persist();
    try{ _cloudSaveHook(id, idx); }catch(e){}

    var el=document.getElementById(sid+'-count'); if(el) el.textContent='尚未設定';
    var fel=document.getElementById('fav-'+sid+'-count'); if(fel) fel.textContent='尚未設定';
  }
  function resumeTimer(id,idx,end,a,preFired){
    var did=idEncode(id), sid=did+'-'+idx;
    clearInterval(timers[sid]);
    timers[sid]=setInterval(function(){
      var remain=Math.max(0,Math.floor((end-Date.now())/1000));
      var mm=Math.floor(remain/60).toString();
      var ss=(remain%60); ss=(ss<10?'0':'')+ss;
      var mainEl=document.getElementById(sid+'-count'); if(mainEl) mainEl.textContent='剩餘 '+mm+':'+ss;
      var favEl=document.getElementById('fav-'+sid+'-count'); if(favEl) favEl.textContent='剩餘 '+mm+':'+ss;

      var sref = saved[id][idx]||{};
      if(!sref._preFired && a>0 && remain===a*60){
        playChime();
        var name = (id===CUSTOM_ID && sref.title) ? sref.title : (id+' 分流'+(idx+1));
        alert(name+' 還有 '+a+' 分鐘');
        sref._preFired = true; saved[id][idx]=sref; persist();
        try{ _cloudSaveHook(id, idx); }catch(e){}
      }
      if(remain<=0){
        clearInterval(timers[sid]);
        playChime();
        var name2 = (id===CUSTOM_ID && (saved[id][idx]||{}).title) ? (saved[id][idx]||{}).title : (id+' 分流'+(idx+1));
        alert(name2+' 時間到');
        var s=saved[id][idx]||{};
        saved[id][idx]={h:s.h,m:s.m,s:s.s,a:s.a,fav:!!s.fav,title:s.title};
        persist();
        try{ _cloudSaveHook(id, idx); }catch(e){}
        if(mainEl) mainEl.textContent='尚未設定';
        if(favEl) favEl.textContent='尚未設定';
      }
    },1000);
  }

  // ===== 事件委派 =====
  document.body.addEventListener('click', function(e){
    var t=e.target;
    if(t.classList.contains('add-stream')){
      var id=t.dataset.id; ensureStreams(id);
      var obj={a:5,fav:false};
      if(id===CUSTOM_ID){ obj.title='自訂計時器 '+(saved[id].length+1); }
      saved[id].push(obj); persist(); try{ _cloudSaveHook(id, saved[id].length-1); }catch(e){} renderStreams(id); return;
    }
    if(t.classList.contains('fav-btn')){
      var id=t.dataset.id, idx=+t.dataset.idx;
      var s=saved[id][idx]||(saved[id][idx]={});
      s.fav=!s.fav; persist(); try{ _cloudSaveHook(id, idx); }catch(e){}
      var key = id+'#'+idx;
      if(s.fav){
        if(!Array.isArray(saved._favOrder)) saved._favOrder=[];
        if(saved._favOrder.indexOf(key)===-1) saved._favOrder.push(key);
      }else{
        if(Array.isArray(saved._favOrder)){
          saved._favOrder = saved._favOrder.filter(function(k){ return k!==key; });
        }
      }
      persist();
      renderStreams(id); renderFavs(); return;
    }
    if(t.classList.contains('start')){ startTimer(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('pin-top')){ moveFavTop(t.dataset.key); return; }
    if(t.classList.contains('move-up')){ moveFav(t.dataset.key,'up'); return; }
    if(t.classList.contains('move-down')){ moveFav(t.dataset.key,'down'); return; }
    if(t.classList.contains('pause')){ pauseTimer(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('reset')){ resetTimer(t.dataset.id, +t.dataset.idx); return; }
    if(t.classList.contains('del')){
      var arr=saved[t.dataset.id]; arr.splice(+t.dataset.idx,1); persist();
      try{
        if(saved[t.dataset.id]){ saved[t.dataset.id].forEach(function(_s,_i){ _cloudSaveHook(t.dataset.id, _i); }); }
      }catch(e){}
      renderStreams(t.dataset.id); renderFavs(); return;
    }
    if(t.classList.contains('goto')){
      var did=idEncode(t.dataset.id), box=document.getElementById(did+'-streams'); if(!box) return;
      var el=box.children[+t.dataset.idx]; if(!el) return; el.scrollIntoView({behavior:'smooth',block:'center'}); return;
    }
  });

  document.getElementById('btnReset').addEventListener('click', function(){
    try{ localStorage.removeItem(KEY); }catch(e){}
    location.reload();
  });

  // 啟動
  renderAll();
})();
</script>

<!-- Firebase Shared-Room Sync -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, doc, setDoc, collection, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

  // 你的專案設定（已替換）
  const firebaseConfig = {
    apiKey: "AIzaSyAW6K7lcjOSWYbajxQAgR-5RB28b7jDbDM",
    authDomain: "bosstimer-shared.firebaseapp.com",
    projectId: "bosstimer-shared",
    storageBucket: "bosstimer-shared.firebasestorage.app",
    messagingSenderId: "737526288161",
    appId: "1:737526288161:web:f377c2a8dda3f874a97860"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  // 房間：?room=global（預設 global）
  const roomId = new URL(location.href).searchParams.get('room') || 'global';
  window.__ROOM_ID__ = roomId;

  // 匿名登入
  signInAnonymously(auth).catch(console.error);
  onAuthStateChanged(auth, () => startCloudSync());

  // 雲端 → 本地 saved（即時）
  function startCloudSync(){
    const streamsCol = collection(db, 'rooms', roomId, 'streams');
    onSnapshot(streamsCol, (snap) => {
      let changed = false;
      snap.forEach(docSnap => {
        const data = docSnap.data();
        const id = (data.chap || '') + '-' + (data.map || '');
        const idx = data.idx || 0;
        if(!window.saved) window.saved = {};
        if(!saved[id]) saved[id] = [];
        if(!saved[id][idx]) saved[id][idx] = {};
        saved[id][idx] = {
          ...saved[id][idx],
          h: data.h||0,
          m: data.m||0,
          s: data.s||0,
          a: (typeof data.a==='number'?data.a:5),
          end: data.end || null,
          fav: !!data.fav,
          title: data.title || null,
          _preFired: !!saved[id][idx]?._preFired
        };
        changed = true;
      });
      if(changed){
        if(typeof persist === 'function') persist();
        if(Array.isArray(saved._chapOrder) && typeof renderStreams === 'function'){
          saved._chapOrder.forEach(ch => renderStreams(ch));
        }
        if(typeof renderFavs === 'function') renderFavs();
      }
    });
  }

  // 本地 → 雲端（persist 之後呼叫）
  async function saveStreamToCloud(id, idx, s){
    const sid = encodeURIComponent(id) + '-' + idx;
    const ref = doc(db, 'rooms', roomId, 'streams', sid);
    const parts = id.split('-');
    const chap = parts[0] || '';
    const map  = parts.slice(1).join('-') || '';
    await setDoc(ref, {
      chap, map, idx,
      h: s?.h||0, m: s?.m||0, s: s?.s||0,
      a: (typeof s?.a==='number'?s.a:5),
      end: s?.end || null,
      fav: !!(s && s.fav),
      title: s?.title || null,
      updatedAt: serverTimestamp(),
    }, { merge: true });
  }

  // 提供給主程式呼叫的 hook
  window._cloudSaveHook = async function(id, idx){
    try{
      const s = (window.saved && saved[id]) ? (saved[id][idx]||{}) : {};
      await saveStreamToCloud(id, idx, s);
    }catch(e){ console.error(e); }
  };
</script>
</body>
</html>
